generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model consignados {
  id             String           @id
  userId         String
  tipo           TipoConsignado
  valor          Decimal          @db.Decimal(10, 2)
  valorParcela   Decimal          @db.Decimal(10, 2)
  numeroParcelas Int
  parcelasPagas  Int              @default(0)
  dataInicio     DateTime
  dataTermino    DateTime
  status         StatusConsignado @default(ATIVO)
  consignataria  String?
  observacoes    String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  users          users            @relation(fields: [userId], references: [id])
}

model funcionarios {
  id             String          @id
  nome           String
  cpf            String          @unique
  matricula      String?
  tipo           TipoFuncionario
  orgao          String
  setor          String?
  salario        Decimal?        @db.Decimal(10, 2)
  margemConsig   Decimal?        @db.Decimal(10, 2)
  email          String?
  telefone       String?
  endereco       String?
  dataAdmissao   DateTime?
  dataNascimento DateTime?
  ativo          Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime
}

model users {
  id                String        @id @default(cuid())
  email             String        @unique
  name              String
  password          String
  role              UserRole      @default(USER)
  cpf               String?       @unique
  phone             String?
  active            Boolean       @default(true)
  permissions       String[]      @default([])
  resetToken        String?
  resetTokenExpiry  DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  createdById       String?
  consignados       consignados[]
  auditLogs         AuditLog[]
  users             users?        @relation("usersTousers", fields: [createdById], references: [id])
  other_users       users[]       @relation("usersTousers")
  vendasCreated     Venda[]       @relation("VendaCreatedBy")
  vendasUpdated     Venda[]       @relation("VendaUpdatedBy")
  parcelasCreated   Parcela[]     @relation("ParcelaCreatedBy")
  parcelasUpdated   Parcela[]     @relation("ParcelaUpdatedBy")
}

model convenio {
  id         Int       @id @default(autoincrement())
  userId     String?
  codigo     String?
  data       DateTime?
  razao_soc  String
  fantasia   String?
  desconto   Decimal?  @db.Decimal(10, 2)
  cgc        String?
  ie         String?
  cpf        String?
  rg         String?
  endereco   String?
  bairro     String?
  cep        String?
  cidade     String?
  uf         String?
  fone       String?
  fax        String?
  contato    String?
  agencia    String?
  conta      String?
  banco      String?
  usuario    String?
  senha      String?
  parcelas   Int?
  mensagem   String?
  libera     String?
  email      String?
  chave      String?
  convenio   Int?
  nome       String?
  cnpj       String?
  tipo       String?
  estado     String?
  telefone   String?
  ativo      Boolean   @default(true)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  vendas     Venda[]
}

model Empresa {
  id        Int       @id @default(autoincrement())
  userId    String?
  nome      String
  cnpj      String?
  tipo      TipoEmpresa?
  telefone  String?
  email     String?
  contato   String?
  cep       String?
  rua       String?
  numero    String?
  bairro    String?
  cidade    String?
  uf        String?
  ativo     Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  socios    Socio[]

  @@map("empresas")
}

model Socio {
  id              String    @id @default(cuid())
  userId          String?
  nome            String
  cpf             String?
  rg              String?
  matricula       String?
  empresaId       Int?
  funcao          String?
  lotacao         String?
  endereco        String?
  bairro          String?
  cep             String?
  cidade          String?
  uf              String?
  telefone        String?
  celular         String?
  email           String?
  contato         String?
  dataCadastro    DateTime?
  dataAdmissao    DateTime?
  dataNascimento  DateTime?
  limite          Decimal?  @db.Decimal(10, 2)
  margemConsig    Decimal?  @db.Decimal(10, 2)
  gratificacao    Decimal?  @db.Decimal(10, 2)
  autorizado      String?
  sexo            String?
  estadoCivil     String?
  numCompras      Int?
  tipo            String?
  agencia         String?
  conta           String?
  banco           String?
  devolucao       Decimal?  @db.Decimal(10, 2)
  bloqueio        String?
  motivoBloqueio  String?
  codTipo         Int?
  senha           String?
  dataExclusao    DateTime?
  motivoExclusao  String?
  ativo           Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  empresa         Empresa?  @relation(fields: [empresaId], references: [id])
  vendas          Venda[]

  @@index([nome])
  @@index([matricula])
  @@index([ativo])
  @@index([empresaId])
  @@map("socios")
}

model Venda {
  id              String    @id @default(cuid())
  userId          String
  socioId         String
  convenioId      Int?
  numeroVenda     Int
  dataEmissao     DateTime  @default(now())
  operador        String?
  observacoes     String?
  quantidadeParcelas Int
  valorParcela    Decimal   @db.Decimal(10, 2)
  valorTotal      Decimal   @db.Decimal(10, 2)
  ativo           Boolean   @default(true)
  cancelado       Boolean   @default(false)
  motivoCancelamento String?
  createdById     String?
  updatedById     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  socio           Socio     @relation(fields: [socioId], references: [id])
  convenio        convenio? @relation(fields: [convenioId], references: [id])
  createdBy       users?    @relation("VendaCreatedBy", fields: [createdById], references: [id])
  updatedBy       users?    @relation("VendaUpdatedBy", fields: [updatedById], references: [id])
  parcelas        Parcela[]

  @@unique([socioId, numeroVenda])
  @@index([userId])
  @@index([socioId])
  @@index([convenioId])
  @@index([dataEmissao])
  @@index([ativo])
  @@index([createdById])
  @@index([updatedById])
  @@map("vendas")
}

model Parcela {
  id              String    @id @default(cuid())
  vendaId         String
  numeroParcela   Int
  dataVencimento  DateTime
  valor           Decimal   @db.Decimal(10, 2)
  baixa           String?   @db.Char(1)
  dataBaixa       DateTime?
  valorPago       Decimal?  @db.Decimal(10, 2)
  tipo            String?   @db.Char(1)
  observacoes     String?
  createdById     String?
  updatedById     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  venda           Venda     @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  createdBy       users?    @relation("ParcelaCreatedBy", fields: [createdById], references: [id])
  updatedBy       users?    @relation("ParcelaUpdatedBy", fields: [updatedById], references: [id])

  @@unique([vendaId, numeroParcela])
  @@index([vendaId])
  @@index([dataVencimento])
  @@index([baixa])
  @@index([createdById])
  @@index([updatedById])
  @@map("parcelas")
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String
  userName    String
  userRole    String
  action      String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc
  module      String   // funcionarios, consignatarias, usuarios, etc
  entityId    String?  // ID da entidade afetada
  entityName  String?  // Nome da entidade afetada
  description String   // Descrição detalhada da ação
  metadata    Json?    // Dados adicionais (valores anteriores, novos valores, etc)
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  user        users    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([module])
  @@index([createdAt])
  @@map("audit_logs")
}

enum StatusConsignado {
  ATIVO
  QUITADO
  CANCELADO
  SUSPENSO
}

enum TipoConsignado {
  EMPRESTIMO
  CARTAO_CREDITO
  SEGURO
  PLANO_SAUDE
  OUTROS
}

enum TipoFuncionario {
  PUBLICO
  PRIVADO
  APOSENTADO
}

enum UserRole {
  ADMIN
  MANAGER
  OPERATOR
  USER
}

enum TipoEmpresa {
  PUBLICO
  PRIVADO
  MISTO
}
